<html>

<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls {
      margin-bottom: 20px;
    }
    .checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .legend rect {
      width: 12px;
      height: 12px;
    }
    .legend text {
      font-size: 12px;
      alignment-baseline: middle;
    }
    svg {
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>

<body>
  <h1>Recovery of the Film Industry Post-Covid</h1>
    
  <div class="topnav">
        <a href="index.html">What Happened in 2020</a>
        <a href="scene1.html">Pre-Pandemic Trends</a>
        <a class="active" href="scene2.html">Recovery: Overall Box Office Revenue</a>
        <a href="scene3.html">Recovery: Per Release Revenue</a>
  </div>
  
  <div class="container">
    <div class="column" style="width:50%">
        <!-- Checkboxes -->
        <div class="controls">
            <label><strong>Select years to display:</strong></label>
            <div class="checkboxes" id="year-checkboxes"></div>
        </div>
        
        <!-- Charts -->
        <div class="chart-container" style="position: relative; width: 100%; height: 500px;">
            <svg id="chart1" preserveAspectRatio="xMidYMid meet" 
                style="width: 100%; height: 100%; z-index: 999;"></svg> 
            <svg id="chart2" preserveAspectRatio="xMidYMid meet" 
                style="width: 100%; height: 100%; opacity: 0.3; z-index: 0;"></svg> 
        </div>

        <!-- Toggle button -->
        <div class="button-container" style="position: relative; width: 100%">
            <button id="toggleBtn">Click to remove the pre-Covid revenue</button>
        </div>

        <script>
            const svgElement = document.getElementById("chart1");
            const bounds = svgElement.getBoundingClientRect();

            const margin = { top: 40, right: 40, bottom: 50, left: 80 },
                width = bounds.width - margin.left - margin.right,
                height = (bounds.height || 500) - margin.top - margin.bottom;

            const svg1 = d3.select("#chart1")
                .attr("viewBox", `0 0 ${bounds.width} ${bounds.height}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            const svg2 = d3.select("#chart2")
                .attr("viewBox", `0 0 ${bounds.width} ${bounds.height}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().range([0, width]);
            const y = d3.scaleLinear().range([height, 0]);
            
            const line = d3.line()
                .x(d => x(d.week))
                .y(d => y(d.overall_gross));

            const parseDate = d3.timeParse("%m/%d/%Y");
            const parseDollar = d => +d.replace(/[\$,]/g, "");

            const csvUrl_all = "https://raw.githubusercontent.com/jlreno2/jlreno2.github.io/main/weekly_box_office_summary_2015_2025.csv";
            const csvUrl_avg = "https://raw.githubusercontent.com/jlreno2/jlreno2.github.io/main/weekly_box_office_average_2015_2019.csv";

            d3.csv(csvUrl_all, function(row) {
                row.year = +row.year;
                row.week_begin_date = parseDate(row.week_begin_date);
                row.week = +row.week_nbr;
                row.top_release = row.top_release
                row.overall_gross = parseDollar(row.overall_gross);
                return row;
            }).then(function(data) {
                data = data.filter(d => d.week && !isNaN(d.overall_gross));
                x.domain(d3.extent(data, d => d.week));
                y.domain([0, d3.max(data, d => d.overall_gross)]);

                svg1.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).ticks(12).tickFormat(d => `Wk ${d}`));

                svg1.append("g")
                    .call(d3.axisLeft(y).tickFormat(d => `$${(d / 1e6).toFixed(0)}M`))
                    .append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", `rotate(-90)`)
                    .attr("y", -60)
                    .attr("x", -height / 2)
                    .attr("dy", "1em")
                    .style("fill", "#333")
                    .style("font-size", "14px")
                    .text("Weekly Gross Revenue");

                const recoveryYears = ["2021","2022","2023","2024","2025"];

                const dataByYear = d3.nest().key(d => d.year).entries(data);
                const yearSet = dataByYear
                    .filter(d => recoveryYears.includes(String(d.key)))
                    .map(d => d.key).sort();
                const pathGroup = svg1.append("g");

                const checkboxesContainer = d3.select("#year-checkboxes");
                const currentVisible = new Set();

                yearSet.forEach(year => {
                    const label = checkboxesContainer.append("label").style("margin-right", "12px");
                    label.append("input")
                    .attr("type", "checkbox")
                    .attr("value", year)
                    .on("change", function() {
                        const yearKey = this.value;
                        if (this.checked) {
                            if (!currentVisible.has(yearKey)) {
                                drawLine(yearKey);
                                currentVisible.add(yearKey);
                            }
                        } else {
                            pathGroup.select(`#line-${yearKey}`).remove();
                            currentVisible.delete(yearKey);
                        }
                    });
                    label.append("span").text(` ${year}`);
                });

                checkboxesContainer.selectAll("input").each(function() {
                    if (recoveryYears.includes(this.value)) {
                        this.checked = true;
                        drawLine(this.value);
                        currentVisible.add(this.value)
                    }
                })

                // Add annotations         
                function drawAnnotations(data, g, x, y) {
                const events = [
                    {
                        type: d3.annotationXYThreshold,
                        title: "Barbenheimer",
                        label: "The highest earning week post-2020 still is lower than several other highs pre-2020.",
                        date: new Date(2023, 6, 21), // 7/21/2023
                        dx: -1,
                        dy: -10,
                        connector: {
                            end: "dot"
                        }
                    },
                    {
                        type: d3.annotationCalloutCircle,
                        title: "Sluggish Holidays",
                        label: "For the season of historically peak revenue, post-2020 holiday revenue has struggled to meet former highs",
                        date: new Date(2024, 11, 6), 
                        dx: -10,
                        dy: -200,
                        subject: {
                            radius: 110
                        }
                    },
                    {
                        type: d3.annotationCalloutCircle,
                        title: "Summer Boom",
                        label: "The most recovered seasonal pattern in the post-2020 years is a sustained increase in weekly revenue in the summer",
                        date: new Date(2024, 5, 21), // 2024 ~ Week 25
                        dx: -75,
                        dy: -120,
                        subject: {
                            radius: 100
                        }
                    }
                ]
                const annotations = events.map(ev => {
                    const closest = data.reduce((a, b) =>
                    Math.abs(b.week_begin_date - ev.date) < Math.abs(a.week_begin_date - ev.date) ? b : a
                    );     
                    return {
                        note: {
                            label: ev.label,
                            title: ev.title,
                            wrap: 130
                        },
                        type: ev.type,
                        x: x(closest.week),
                        y: y(closest.overall_gross),
                        dx: ev.dx,
                        dy: ev.dy,
                        subject: ev.subject,
                        connector: ev.connector
                    };
                });
                const makeAnnotations = d3.annotation()
                    .notePadding(10)
                    .annotations(annotations);
                const annotationGroup = svg1.append("g")
                    .attr("class", "annotation-group")
                    .call(makeAnnotations);
                annotationGroup.lower();
                }                    
                
                // Flag for if annotations have been drawn yet
                let annotationsDrawn = 0;
                
                // Define tooltip
                var tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                // Draw lines
                function drawLine(yearKey) {
                    const yearData = dataByYear.find(d => d.key === yearKey).values
                        .filter(d => d.week)
                        .sort((a, b) => a.week - b.week);
                    
                    const maxWeek = yearData.reduce((a, b) => (a.overall_gross > b.overall_gross ? a : b));

                    const baseColor = getComputedStyle(document.documentElement).getPropertyValue("--tertiary-color").trim();
                    const highlightColor = getComputedStyle(document.documentElement).getPropertyValue("--highlight-color").trim();

                    const path = pathGroup.append("path")
                        .datum(yearData)
                        .attr("id", `line-${yearKey}`)
                        .attr("fill", "none")
                        .attr("stroke", baseColor)
                        .attr("stroke-width", 2)
                        .attr("d", line)
                        // 4. On hover, change to yellow; on exit, restore original
                        .on("mouseover", function() {
                            d3.select(this)
                                .raise()
                                .transition().duration(100)
                                .attr("stroke", highlightColor)
                                .attr("stroke-width", 4);
                            tooltip.style("opacity",1);
                        })
                        .on("mousemove",function() {
                            tooltip.html(`<strong>Year:</strong> ${yearKey}<br/>
                                        <strong>Best Week:</strong> Wk ${maxWeek.week}<br/>
                                        <strong>Best Week Revenue:</strong> $${(maxWeek.overall_gross / 1e6).toFixed(1)}M<br/>
                                        <strong>Best Week Top Release:</strong> ${maxWeek.top_release}`)
                                .style("left", (event.pageX + 20) + "px")
                                .style("top", (event.pageY + 20) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this)
                                .transition().duration(100)
                                .attr("stroke", baseColor)
                                .attr("stroke-width", 2);
                            tooltip.style("opacity", 0);
                        });

                    const totalLength = path.node().getTotalLength();
                    path
                        .attr("stroke-dasharray", totalLength + " " + totalLength)
                        .attr("stroke-dashoffset", totalLength)
                        .transition()
                        .duration(1500)
                        .ease(d3.easeLinear)
                        .attr("stroke-dashoffset", 0)
                        .on("end", () => {
                            if (annotationsDrawn === 0) {
                            drawAnnotations(data, svg1, x, y);
                            annotationsDrawn = 1;
                            }
                        });
                }
            });

            // Line and Area for second chart
            const line2 = d3.line()
                .x(d => x(d.week_nbr))
                .y(d => y(d.avg_overall_gross));

            const area2 = d3.area()
                .x(d => x(d.week_nbr))
                .y0(d => y(d.min_overall_gross))
                .y1(d => y(d.max_overall_gross));

            d3.csv(csvUrl_avg, d => ({
                week_nbr: +d.week_nbr,
                avg_overall_gross: +d.avg_overall_gross,
                min_overall_gross: +d.min_overall_gross,
                max_overall_gross: +d.max_overall_gross
            })).then(data2 => {
                x.domain(d3.extent(data2, d => d.week_nbr));
                y.domain([0, d3.max(data2, d => d.max_overall_gross)]);

                svg2.append("path")
                    .datum(data2)
                    .attr("fill", getComputedStyle(document.documentElement).getPropertyValue("--secondary-color").trim())
                    .attr("opacity", 0.5)
                    .attr("d", area2);

                svg2.append("path")
                    .datum(data2)
                    .attr("fill", "none")
                    .attr("stroke", getComputedStyle(document.documentElement).getPropertyValue("--primary-color").trim())
                    .attr("stroke-width", 2)
                    .attr("d", line2);

                svg2.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).ticks(10).tickFormat(d => `Wk ${d}`));

                svg2.append("g")
                    .call(d3.axisLeft(y).tickFormat(d => `$${(d / 1e6).toFixed(0)}M`));
            });

            // Toggle behavior
            let showingChart1 = true;
            document.getElementById("toggleBtn").addEventListener("click", () => {
                showingChart1 = !showingChart1;
                d3.select("#chart1").style("opacity", showingChart1 ? 1 : 1);
                d3.select("#chart2").style("opacity", showingChart1 ? 0.3 : 0);
                document.getElementById("toggleBtn").textContent = showingChart1 ? "Click to remove the pre-Covid revenue" : "Click to include the pre-Covid revenue";
            });
        </script>

    </div>

    <!-- Explaining trents 2021 onward / Initial answer to our question -->
    <div class="column" style="width:50%">
        <p>
            In this graph we compare the trends noted in the years since 2020 to the pre-2020 averages. 
            Note that 2021's slow start was due to theaters staying closed, but that years 2022 onward have 
            maintained seasonal trends to a lesser extent than pre-2020 years.
        </p>
        <p>
            End of year / holiday weeks continue to see spikes compared to fall weekly averages, but to a smaller scale. 
            Instead of the clear high-revenue period for the year, the season matches closer to summer. 
        </p>
        <p>
            We continue to see spikes when there are blockbuster releases. 
            For example, the co-releases of Barbie and Oppenheimer in the summer of 2023, and Wicked over the holidays in 2024.
            However, these blockbusters are not creating new high-revenue weeks versus the pre-2020 weekly revenues.             
        </p>
        <p>
            Having examined the weekly revenues pre- and post-2020, an answer to our initial question on recovery may start to form.
            While there are certainly weeks that surpass pre-2020 performance, the overall patterns remain consistently lower, 
            even into 2025. If we took inflation into account, the numbers would look even lower for the post-2020 
            years compared to the pre-2020 years.
        </p>
        <p>
            So, <b> has the domestic box office recovered? </b> 
            It's easy to say no - the industry seems to be facing a permanently altered landscape. 
            But there's another side to the story. Not only were theaters shuttered during 2020, but many film productions were halted.
            Additionally, COVID-19 was followed a few years later by months-long strikes in the writers and actors guilds, marking
            another halt in production. Given how long it takes to produce movies, the industry may be struggling outside of audiences.
            How does the story change if we examine the revenue on a <i>per release</i> basis?
        </p>
        <a href="scene1.html" class="previous">&laquo; Previous</a>
        <a href="scene3.html" class="next">Next &raquo;</a>

    </div>
    
  </div>

</body>

</html>