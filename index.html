<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Recovery of the Film Industry Post-Covid</h1>

    <div class="topnav">
        <a class="active" href="index.html">What Happened in 2020</a>
        <a href="scene1.html">Pre-Pandemic Trends</a>
        <a href="scene2.html">Recovery: Overall Box Office Revenue</a>
        <a href="scene3.html">Recovery: Per Release Revenue</a>
    </div>

    <div class="container">
        
        <div class="column" style="width:50%">
            <svg width="900" height="500"></svg>
            <script>
                const svg = d3.select("svg"),
                margin = { top: 40, right: 40, bottom: 50, left: 80 },
                width = +svg.attr("width") - margin.left - margin.right,
                height = +svg.attr("height") - margin.top - margin.bottom;

                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const parseDate = d3.timeParse("%m/%d/%Y");
                const parseDollar = d => +d.replace(/[\$,]/g, "");

                const x = d3.scaleTime().range([0, width]);
                const y = d3.scaleLinear().range([height, 0]);

                const line = d3.line()
                .x(d => x(d.week_begin_date))
                .y(d => y(d.overall_gross));

                const csvUrl = "https://raw.githubusercontent.com/jlreno2/jlreno2.github.io/main/weekly_box_office_summary_2015_2025.csv";

                d3.csv(csvUrl, function(row) {
                // Parse each row before the full data is returned
                if (row.year === "2019" || row.year === "2020" || row.year === "2021") {
                    row.week_begin_date = parseDate(row.week_begin_date);
                    row.overall_gross = parseDollar(row.overall_gross);
                    return row;
                }
                }).then(function(data) {
                    data = data.filter(d => d && d.week_begin_date && !isNaN(d.overall_gross));
                    data.sort((a, b) => a.week_begin_date - b.week_begin_date);
                    x.domain(d3.extent(data, d => d.week_begin_date));
                    y.domain([0, d3.max(data, d => d.overall_gross)]);

                    g.append("g")
                        .attr("transform", `translate(0,${height})`)
                        .call(d3.axisBottom(x));

                    g.append("g")
                        .call(d3.axisLeft(y).tickFormat(d => `$${(d / 1e6).toFixed(0)}M`));
                    
                    // Add line path with transition
                    const path = g.append("path")
                        .datum(data)
                        .attr("class", "line")
                        .attr("d", line);
                    const totalLength = path.node().getTotalLength();
                    path.attr("stroke-dasharray",totalLength+" "+totalLength)
                        .attr("stroke-dashoffset",totalLength)
                        .transition()
                        .duration(3000)
                        .ease(d3.easeLinear)
                        .attr("stroke-dashoffset",0)
                        .on("end", () => {
                            drawShutdownAnnotation(data, g, x, y);
                        });

                    // Add annotations
                    function drawShutdownAnnotation(data, g, x, y) {
                        const events = [
                            {
                                type: d3.annotationCalloutCircle,
                                title: "March 2020 Collapse",
                                label: "Theaters nationwide shut down due to COVID-19",
                                date: new Date(2020, 2, 15), // March 15, 2020
                                dx: 30,
                                dy: -50,
                                subject: {
                                    radius: 50
                                }
                            },
                            {
                                title: "Avengers: Endgame",
                                label: "Week 17 of 2019 saw record revenue from 'Endgame'",
                                date: new Date(2019, 3, 26), // April 26, 2019 
                                dx: 25,
                                dy: 0,
                                connector: {
                                    end: "dot"
                                }
                            },
                            {
                                title: "Summer Rebound",
                                label: "Box office began recovering as theaters reopened",
                                date: new Date(2021, 4, 28), // May 28, 2021: A Quiet Place Part II
                                dx: -25,
                                dy: -80,
                                connector: {
                                    end: "dot"
                                }
                            },
                            {
                                title: "Spider-Man Surge",
                                label: "'No Way Home' drove an end-of-year spike in December",
                                date: new Date(2021, 11, 17), // Dec 17, 2021
                                dx: -50,
                                dy: 40,
                                connector: {
                                    end: "dot"
                                }
                            }
                        ]
                        const annotations = events.map(ev => {
                            const closest = data.reduce((a, b) =>
                                Math.abs(b.week_begin_date - ev.date) < Math.abs(a.week_begin_date - ev.date) ? b : a
                            );
                            return {
                                note: {
                                    label: ev.label,
                                    title: ev.title,
                                    wrap: 220
                                },
                                x: x(closest.week_begin_date),
                                y: y(closest.overall_gross),
                                dx: ev.dx,
                                dy: ev.dy,
                                type: ev.type,
                                connector: ev.connector,
                                subject: ev.subject
                            };
                        });
                        const makeAnnotations = d3.annotation()
                            .type(d3.annotationXYThreshold) // annotationLabel
                            .notePadding(10)
                            .annotations(annotations);
                        g.append("g")
                            .attr("class", "annotation-group")
                            .call(makeAnnotations);
                    }                    
                });

            </script>
        </div>

        <div class="column" style="width:50%">
            <p>
                In 2020, the film industry was one of many industries shuttered by COVID-19 lockdowns.
                Theaters closed worldwide, box office revenue plummeted, and major studios were forced to rethink distribution strategies. 
                One of the most significant shifts during this period was the increase in direct-to-streaming releases, as platforms such as Netflix 
                grew massively. This change not only altered how audiences consumed films but also raised questions about the long-term role of theatrical releases.
            </p>
            <p>
                <b>Today, more than five years since the initial shutdowns, has the industry recovered?</b>
                This analysis explores weekly box office revenue before and after the pandemic to assess whether the film industry has rebounded, 
                or if it is still navigating a permanently altered landscape.
            </p>
            <p>
                We'll focus on domestic box office revenue for the United States. 
                Data is sourced from: <a href="https://www.boxofficemojo.com/">Box Office Mojo</a>
            </p>
            <p></p> 
            <p>
                To understand recovery, we first can examine the timeline of box office performance the year before, after, and during 2020.  
                Domestic box office revenue during 2019 was high, with the year totalling over $11 million - the third highest year for domestic revenue ever. 
                Weekly revenue started off good in 2020, but turned to near-zero in March when the country went on lockdown and theaters closed. 
                It wasn't until June of 2021 that many movie theaters began to open again, and it took another several months before any week resembled the pre-pandemic revenue.
                By the end of 2021, a big box-office hit in "Spider-Man: No Way Home" signaled the potential for a true recovery in the years to come.
            </p>
            <a href="scene1.html" class="next">Next &raquo;</a>
        </div>
        
    </div>
    
</body>