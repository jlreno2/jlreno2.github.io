<!-- Scene 1A investigates the pre-2020 trends and creates an average weekly revenue chart 
 that we use to compare with post-2020 revenue -->
<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    .chart-container {
      position: relative;
      width: 900px;
      height: 500px;
    }
    svg {
      position: absolute;
      top: 0;
      left: 0;
    }
    #chart1 {
      opacity: 1;
      z-index: 1;
    }
    #chart2 {
      opacity: 0;
      z-index: 0;
    }
  </style>
</head>

<body>
  <h1>Recovery of the Film Industry Post-Covid</h1>

  <div class="topnav">
        <a href="index.html">What Happened in 2020</a>
        <a class="active" href="scene1.html">Pre-Pandemic Trends</a>
        <a href="scene2.html">Recovery: Overall Box Office Revenue</a>
        <a href="scene3.html">Recovery: Per Release Revenue</a>
  </div>

  <div class="container">
    <div class="column" style="width:50%">
      <div class="chart-container">
        <svg id="chart1" width="900" height="500"></svg>
        <svg id="chart2" width="900" height="500"></svg>
      </div>

      <div class="button-container">
        <button id="toggleBtn">Click to see the average</button>
      </div>
            
      <script>
        const svg1 = d3.select("#chart1").append("g").attr("transform", "translate(80,40)");
        const svg2 = d3.select("#chart2").append("g").attr("transform", "translate(80,40)");

        const margin = { top: 40, right: 40, bottom: 50, left: 80 },
              width = 900 - margin.left - margin.right,
              height = 500 - margin.top - margin.bottom;

        const x = d3.scaleLinear().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const line = d3.line()
          .x(d => x(d.week))
          .y(d => y(d.overall_gross));

        const parseDate = d3.timeParse("%m/%d/%Y");
        const parseDollar = d => +d.replace(/[\$,]/g, "");

        const csvUrl1 = "https://raw.githubusercontent.com/jlreno2/jlreno2.github.io/main/weekly_box_office_summary_2015_2025.csv";

        d3.csv(csvUrl1, function(row) {
          row.year = +row.year;
          row.week_begin_date = parseDate(row.week_begin_date);
          row.week = +row.week_nbr;
          row.overall_gross = parseDollar(row.overall_gross);
          return row;
        }).then(function(data) {
          data = data.filter(d => d.week && !isNaN(d.overall_gross));
          x.domain(d3.extent(data, d => d.week));
          y.domain([0, d3.max(data, d => d.overall_gross)]);

          svg1.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(12).tickFormat(d => `Wk ${d}`));

          svg1.append("g")
            .call(d3.axisLeft(y).tickFormat(d => `$${(d / 1e6).toFixed(0)}M`));

          const dataByYear = d3.nest().key(d => d.year).entries(data);
          const yearSet = dataByYear.map(d => d.key).sort();
          const pathGroup = svg1.append("g");

          const baselineYears = ["2015","2016","2017","2018","2019"];
          baselineYears.forEach((year) => {
            drawLine(year);
          });

          // Flag for if annotations have been drawn yet
          let annotationsDrawn = 0;

          // Define tooltip
          var tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

          // Main function for first graph
          function drawLine(yearKey) {
            const yearData = dataByYear.find(d => d.key === yearKey).values
              .filter(d => d.week)
              .sort((a, b) => a.week - b.week);

            // Set line colors
            const baseColor = getComputedStyle(document.documentElement).getPropertyValue("--primary-color").trim();
            const highlightColor = getComputedStyle(document.documentElement).getPropertyValue("--highlight-color").trim();

            // Append the path
            const path = pathGroup.append("path")
              .datum(yearData)
              .attr("id", `line-${yearKey}`)
              .attr("fill", "none")
              .attr("stroke", baseColor)
              .attr("stroke-width", 2)
              .attr("d", line)
              // On hover, change to yellow; on exit, restore original
              .on("mouseover", function() {
                d3.select(this)
                  .raise()
                  .transition().duration(100)
                  .attr("stroke", highlightColor)
                  .attr("stroke-width", 4);
                if (showingChart1 === true) {
                  tooltip.style("opacity",1);
                }
              })
              .on("mousemove",function() {
                tooltip.html(`<strong>Year:</strong> ${yearKey}`)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY + 10) + "px");
              })
              .on("mouseout", function() {
                d3.select(this)
                  .transition().duration(100)
                  .attr("stroke", baseColor)
                  .attr("stroke-width", 2);
                tooltip.style("opacity", 0);
              })

            // Add annotations         
            function drawAnnotations(data, g, x, y) {
              const events = [
                {
                  type: d3.annotationCalloutCircle,
                  title: "Holiday Spikes",
                  label: "Highest annual revenue around year-end holidays",
                  date: new Date(2017, 11, 22), // week 51 2017
                  dx: -75,
                  dy: -10,
                  subject: {
                    radius: 68
                  },
                  wrap: 140
                },
                {
                  type: d3.annotationXYThreshold,
                  title: "High Performer",
                  label: "'Suicide Squad' in 2016 drove higher-than-average revenue for week 32",
                  date: new Date(2016, 7, 5), // 8/5/2016
                  dx: 25,
                  dy: -25,
                  wrap: 180
                },
                {
                  type: d3.annotationXYThreshold,
                  title: "High Performer",
                  label: "'Beauty and the Beast' in 2017 drove higher-than-average revenue for the week 11",
                  date: new Date(2017, 2, 17), // 3/17/2017
                  dx: -1,
                  dy: -60,
                  wrap: 140
                }
              ]
              const annotations = events.map(ev => {
                const closest = data.reduce((a, b) =>
                  Math.abs(b.week_begin_date - ev.date) < Math.abs(a.week_begin_date - ev.date) ? b : a
                );     
                return {
                    note: {
                        label: ev.label,
                        title: ev.title,
                        wrap: ev.wrap
                    },
                    type: ev.type,
                    x: x(closest.week),
                    y: y(closest.overall_gross),
                    dx: ev.dx,
                    dy: ev.dy,
                    subject: ev.subject
                };
              });
              const makeAnnotations = d3.annotation()
                  .notePadding(10)
                  .annotations(annotations);
              const annotationGroup = svg1.append("g")
                  .attr("class", "annotation-group")
                  .call(makeAnnotations);
              annotationGroup.lower();
            }                    
            
            const totalLength = path.node().getTotalLength();
            path
              .attr("stroke-dasharray", totalLength + " " + totalLength)
              .attr("stroke-dashoffset", totalLength)
              .transition()
              .duration(1500)
              .ease(d3.easeLinear)
              .attr("stroke-dashoffset", 0)
              .on("end", () => {
                if (annotationsDrawn === 0) {
                  drawAnnotations(data, svg1, x, y);
                  annotationsDrawn = 1;
                }
              });
          }
        });

        // Line and Area for second chart
        const line2 = d3.line()
          .x(d => x(d.week_nbr))
          .y(d => y(d.avg_overall_gross));

        const area2 = d3.area()
          .x(d => x(d.week_nbr))
          .y0(d => y(d.min_overall_gross))
          .y1(d => y(d.max_overall_gross));

        const csvUrl2 = "https://raw.githubusercontent.com/jlreno2/jlreno2.github.io/main/weekly_box_office_average_2015_2019.csv";

        d3.csv(csvUrl2, d => ({
          week_nbr: +d.week_nbr,
          avg_overall_gross: +d.avg_overall_gross,
          min_overall_gross: +d.min_overall_gross,
          max_overall_gross: +d.max_overall_gross
        })).then(data2 => {
          x.domain(d3.extent(data2, d => d.week_nbr));
          y.domain([0, d3.max(data2, d => d.max_overall_gross)]);

          svg2.append("path")
            .datum(data2)
            .attr("fill", getComputedStyle(document.documentElement).getPropertyValue("--secondary-color").trim())
            .attr("opacity", 0.5)
            .attr("d", area2);

          svg2.append("path")
            .datum(data2)
            .attr("fill", "none")
            .attr("stroke", getComputedStyle(document.documentElement).getPropertyValue("--primary-color").trim())
            .attr("stroke-width", 2)
            .attr("d", line2);

          svg2.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(10).tickFormat(d => `Wk ${d}`));

          svg2.append("g")
            .call(d3.axisLeft(y).tickFormat(d => `$${(d / 1e6).toFixed(0)}M`));
        });

        // Toggle behavior
        let showingChart1 = true;
        document.getElementById("toggleBtn").addEventListener("click", () => {
          showingChart1 = !showingChart1;
          d3.select("#chart1").style("opacity", showingChart1 ? 1 : 0);
          d3.select("#chart2").style("opacity", showingChart1 ? 0 : 1);
          document.getElementById("toggleBtn").textContent = showingChart1 ? "Click to see the average" : "Click to see each line";
        });
      </script>
    </div>

    <!-- Examine the seasonal patterns present pre-2020 -->
    <div class="column"> 
      <p>
        To better understand revenue patterns during a calendar year, we examine data from 2015 - 2019. 
      </p>
      <p>
        If we examine the weekly averages across years, although each individual year may vary drasticly from week to week, patterns
        across the years are less volitile. 
        A few clear patterns emerge: 
        <li>
          On average, the highest earning weeks are at the end of the year in December, as studios capitalize on high spirits and extra free time around the holidays. 
        </li>
        <li>
          A smaller bump in weekly revenue is seen around Thanksgiving for the same reasons.
        </li>
        <li>
          The summer is also a period of high revenue. Kids are out of school and people see movies more often. 
        </li>
      </p>
      <p>
        Weeks with extreme spikes are often due to single movie releases that do especially well. 
        For example, the movies "Suicide Squad" in 2016 and "Beauty and the Best" in 2017 drove especially high revenue for their respective weeks. 
      </p>
      
      <a href="index.html" class="previous">&laquo; Previous</a>
      <a href="scene2.html" class="next">Next &raquo;</a>

    </div>

  </div>
</body>
</html>